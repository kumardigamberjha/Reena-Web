{% extends 'website/index.html' %}

{% block title %}
<title>Booking</title>
{% endblock title %}

{% block csslink %}

{% load static %}

<style>
    /* #phonecon {
        display: none;
    }

    #id_servicescon {
        display: none;
    }

    #datentimecon {
        display: none;
    }

    #paypal-button-container {
        display: none;
    }

    #submit {
        display: none;
    } */
</style>


<!--time-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
<!--jquery-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.1/jquery.min.js"
    integrity="sha512-aVKKRRi/Q/YV+4mjoKBsE4x3H+BkegoM/em46NNlCqNTmUYADjBbeNefNxYV7giUp0VxICtqdrbqU7iVaeZNXA=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


<link href="{% static 'css/booking.css' %}" rel="stylesheet">
<link href="{% static 'css/index.css' %}" rel="stylesheet">
{% endblock csslink %}

{% block body %}

<body style="background-color: black; ">
    {% endblock body %}

    {% block content %}
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <li{% if message.tags %} class="{{ message.tags }} p-2 mb-2 bg-success text-white"
            style="list-style: none; border-radius: 10px; width: 95%; margin: auto auto;" {% endif %}>{{ message }}</li>
            {% endfor %}
    </ul>
    {% endif %}

    {% load widget_tweaks %}

    <div class="main mx-auto" style="margin-top: 9em;">
        <div class="container-fluid bg-light">
            <div class="container bg-secondary" style="box-shadow: 10px 10px 10px black;">
                <div class="row g-3">
                    <div class="col-sm-7">
                        <div class="container border-danger text-center" style="padding: 5px 5px;">
                            {% if not user.is_authenticated %}
                            <a href="{% url 'login' %}"><button class="button mx-auto">SIGN IN</button></a>
                            {% endif %}
                            <a href="{% url 'show_booking' %}"><button class="button mx-auto">Bookings</button></a>
                        </div>

                        <div class="container text-center">
                            <h1>Book Your Appointment</h1>
                        </div>
                        <form action="" method="POST" id="bookingform">
                            {% csrf_token %}
                            <div class="row">

                                <div class="col-md-12">
                                    <label for="name" class="form-label mt-3 text-center"><i
                                            class="fa-solid fa-person mx-2"></i>Your Name</label>
                                    <input type="text" id="name" name="name" class="form-control" required>
                                </div>
                                <div class="col-md-12" id="phonecon">
                                    <label for="phone" class="form-label mt-3 text-center"><i
                                            class="fa-solid fa-address-book mx-2"></i>Phone</label>
                                    <input type="text" name="phone" id="phone" class="form-control" required>
                                    <input type="hidden" name="hidname" value="{{user.username}}">
                                </div>
                            </div>
                            <div class="container" id="id_servicescon">
                                <p class="form-label mt-3"><i class="fa-solid fa-spa mx-2"></i>Search For Service</p>
                                <!-- {% render_field form.services|add_class:"form-control" %} -->
                                <select name="services" id="id_services" class="form-control select2"
                                    multiple="multiple" style="border: 2px solid black;">
                                    {% for i in data %}
                                    <option value="{{i.id}}">{{i.name}} - &#163;{{i.price}}</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" id="total_amount"></input>
                                <input type="hidden" name="total_payment" id="total_payment"></input>
                            </div>


                            <div class="container mb-3" id="datentimecon">
                                <label for="datetime-local" class="form-label mt-3">Select Date and Time</label>
                                <input type="datetime-local" class="form-control border-dark" required name="datentime"
                                    id="datentime" placeholder="Select Date and Time"
                                    style="border-radius:0; text-align: center ; width: 50%;">
                                <div class="container text-center mt-3">
                                    <input type="text" name="" id="timeslot"
                                        style="text-align: center; border: none; margin-top: 5px; background-color: transparent;" />
                                </div>
                            </div>

                            <input type="hidden" name="payment_status" id="paymentstatus">

                            <!-- <div id="paypal-button-container"></div> -->
                            <div id="paypal-button-container" style="width: 50%; margin:auto;"></div>
                            <script
                                src="https://www.paypal.com/sdk/js?client-id=AWFL7YRuIbPx-nbOh0-l8K8yxbOKsaaIzjSC4NMMJEcR3el2R0hEjF26UrosJAx7f9R-QQEXMgb_LT7u&currency=USD"></script>

                            <script>

                                paypal.Buttons({
                                    // Sets up the transaction when a payment button is clicked
                                    createOrder: (data, actions) => {
                                        var amountt = document.getElementById("total_amount").value;
                                        return actions.order.create({
                                            purchase_units: [{
                                                amount: {
                                                    value: amountt // Can also reference a variable or function
                                                }
                                            }]
                                        });
                                    },
                                    // Finalize the transaction after payer approval
                                    onApprove: (data, actions) => {
                                        let amounttt = document.getElementById("total_amount").value;

                                        return actions.order.capture().then(function (orderData) {
                                            console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
                                            const transaction = orderData.purchase_units[0].payments.captures[0];
                                            alert(`Payment has been Done`)
                                            $('#paymentstatus').val("PaymentisDonecheckit");
                                            $('#total_payment').val(amounttt);
                                            $('#submit').css('display', 'block')

                                        });
                                    }
                                }).render('#paypal-button-container');
                            </script>

                            <div class="container text-center">
                                <input type="submit" value="Submit" id="submit" class="button mt-3">
                            </div>
                        </form>

                    </div>
                    <div class="col-sm-5">
                        <img src="{% static 'images/silhouette-3605401.png' %}" class="img-fluid" alt="makeup">
                        <div class="container">
                            <h4>Opening Hours</h4>
                            <p>Monday: Closed<br>
                                Tuesday: 10am - 6pm<br>
                                Wednesday: 10am - 6pm<br>
                                Thursday: 10am - 6pm<br>
                                Friday: 10am - 6pm<br>
                                Saturday: 10am - 6pm<br>
                                Sunday: Closed</p>
                        </div>
                        <div class="container">
                            <h4>Address</h4>
                            <p>207 Waldegrave Road, Teddington, TW11 8LX</p>
                        </div>
                        <div class="container">
                            <h4>Contact</h4>
                            <p>07969385877</p>
                        </div>
                        <div class="container">
                            <h4>Email</h4>
                            <p>reenavirdee@hotmail.com</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="footer mb-2">
        <p></p>
    </div>
    <!--javascript-->
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <!--js-->
    <script>

    </script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        $(document).ready(function () {
            $('#id_services').select2({ width: '100%', placeholder: "Select an Option", allowClear: true, });
        });
    </script>

    <script>
        $('#id_services').change(function () {
            let x = $('#id_services').val()
            $("#contactnumber").attr("autocomplete", "off");

            console.log("C: ", x)
            console.log("HEllo Coding")
            $.ajax({
                type: 'GET',
                url: "{% url 'get_booking_price' %}",
                data: { 'services': x },
                success: function (data) {
                    var instance = JSON.parse(data["amount"]);
                    console.log(instance)
                    $('#total_amount').val(instance);
                    console.log("Done");
                },
                error: function (response) {
                    alert(response["responseJSON"]["error"]);
                }
            })
        })


        // ################## CHECK FOR TIME AND DATE

        $('#datentime').change(function () {
            let x = $('#datentime').val()
            $("#contactnumber").attr("autocomplete", "off");

            console.log("C: ", x)
            console.log("HEllo Coding")
            $.ajax({
                type: 'POST',
                url: "{% url 'get_booking_datentime' %}",
                data: { 'datentime': x, 'csrfmiddlewaretoken': "{{csrf_token}}" },
                success: function (data) {
                    // var instance = JSON.parse(data["amount"]);
                    console.log(data['amount'])
                    $('#timeslot').val(data['amount']);
                    console.log("Done");
                    if (data['amount'] == "Ready To Go") {
                        $('#timeslot').style.color = "green";
                    }
                },
                error: function (error) {

                }
            })
        })


        // Booking Model AJAX CALL 
        $(document).on('submit', '#bookingform', function (event) {
            event.preventDefault();
            let x = $('#bookingform')
            let serv = $('#id_services').val()
            console.log(serv)
            $.ajax({
                type: 'POST',
                url: "{% url 'add_booking' %}",
                data: x.serialize(),

                success: function (data) {
                    console.log("Done");
                    window.location = "/"
                },
                error: function (error) {
                    alert("There is some error")
                    var instance = JSON.parse(data["error"]);
                    alert(instance)
                    console.log("error: ", error)
                }
            })
        })

        let name = document.getElementById('name').value
        let phone = document.getElementById('phone').value
        let services = document.getElementById('id_services').value
        let datentime = document.getElementById('datentime').value
        let paypal_button_container = document.getElementById('paypal-button-container').value

        let paymentstatus = document.getElementById('paymentstatus').value
        let submit = document.getElementById('submit').value

        if (name != "") {
            $('#phonecon').css('display', 'block')
        }
        else {
            $("#name").on("change paste keyup", function () {
                $('#phonecon').css('display', 'block')
            });
        }
        if (phone != "") {
            $('#id_servicescon').css('display', 'block')
        }
        else {
            $("#phone").on("change paste keyup", function () {
                $('#id_servicescon').css('display', 'block')
            });
        }
        if (services != "") {
            $('#datentimecon').css('display', 'block')
        }
        else {
            $("#id_services").on("change paste keyup", function () {
                $('#datentimecon').css('display', 'block')
            });
        }
        if (datentime != "") {
            $('#paypal-button-container').css('display', 'block')
        }
        else {
            $("#datentime").on("change paste keyup", function () {
                $('#paypal-button-container').css('display', 'block')
            });
        }
        if (paymentstatus != "") {
            $('#submit').css('display', 'block')
        }
        else {
            $("#paymentstatus").on("change paste keyup", function () {
            });
        }

    </script>

    <script>
        config = {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            minDate: "today",
            minTime: "10:00",
            maxTime: "18:00",
            inline: true,
            minuteIncrement: 30,

            "disable": [
                function (date) {
                    return (date.getDay() === 0 || date.getDay() === 1);
                }
            ],
            "locale": {
                "firstDayOfWeek": 2 // start week on Monday
            }
        }
        flatpickr("input[type=datetime-local]", config);
    </script>

    {% endblock content %}